@if (isOpen) {
<div class="ig-modal-overlay" (click)="onOverlayClick($event)">
  <div class="ig-modal-container" (click)="$event.stopPropagation()">
    <!-- En-tête dynamique -->
    <div class="d-flex justify-content-between align-items-start p-4 border-bottom ig-modal-header">
      <div class="d-flex flex-column align-items-start gap-3">
        @if (showAddReviewForm) {
        <button class="ig-back-btn" (click)="onBackToReviews()" title="Retour aux avis">
          <i class="fas fa-arrow-left" aria-hidden="true"></i>
          Retour
        </button>
        }
        @if (!showAddReviewForm) {
        <button class="ig-add-review-btn" (click)="onAddReview()" title="Ajouter un avis">
          <i class="fas fa-plus" aria-hidden="true"></i>
          Ajouter un avis
        </button>
        }
        <h3 class="mb-0">{{ showAddReviewForm ? 'Ajouter un avis' : 'Avis Clients' }}</h3>
      </div>
      <button class="ig-modal-close-btn" (click)="onClose()" aria-label="Fermer">&times;</button>
    </div>

    <div class="p-2">
      <!-- Vue des avis existants -->
      @if (!showAddReviewForm) {
      <div>
        <div class="p-4 mb-5 text-center ig-reviews-summary">
          <div class="d-flex flex-row justify-content-between align-items-center gap-2">
            <div class="d-flex flex-row align-items-center gap-2">
              <div class="ig-rating-number">{{ (averageRating$ | async)?.toFixed(2) }}/5</div>
            </div>
            <div class="ig-stars-container">
              <div class="d-flex gap-1">
                <span *ngFor="let star of [0,1,2,3,4]; let i = index" class="ig-star ig-star-enhanced ig-star-white"
                  [ngStyle]="getStarStyle(i, (averageRating$ | async) || 0)">★</span>
              </div>
              <div class="ig-rating-precision">
                <small>Basé sur {{ (reviews$ | async)?.length || 0 }} avis</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Liste des avis -->
        <div class="d-flex flex-column gap-4 mb-5">
          @for (review of (reviews$ | async) || []; track review) {
          <div class="ig-review-item">
            <div class="d-flex flex-column justify-content-between align-items-start mb-3">
              <div class="d-flex">
                <h4 class="ig-reviewer-name">{{ review.name }}</h4>
              </div>
              <div class="d-flex flex-column align-items-end gap-2">
                <div class="d-flex gap-1">
                  @for (star of [0,1,2,3,4]; track $index; let i = $index) {
                  <span class="ig-star ig-star-enhanced" [ngStyle]="getStarStyle(i, review.rating)">★</span>
                  }
                </div>
              </div>
            </div>
            <div class="ig-review-content">
              <p class="ig-review-comment">{{ review.comment }}</p>
            </div>
          </div>
          }
        </div>

        <div class="text-center p-3 ig-reviews-footer">
          <p class="d-flex align-items-center justify-content-center gap-2 mb-0 ig-footer-note">
            <i class="fas fa-shield-alt" aria-hidden="true"></i>
            Tous nos avis sont vérifiés et authentiques
          </p>
        </div>
      </div>
      }

      <!-- Formulaire d'ajout d'avis -->
      @if (showAddReviewForm) {
      <div class="ig-study-form">
        <form (submit)="onSubmitReview()" #reviewForm="ngForm">
          <div class="mb-4 ig-form-group">
            <label for="reviewerName">Nom *</label>
            <input type="text" id="reviewerName" name="name" [(ngModel)]="newReview.name" required
              placeholder="Votre nom">
          </div>

          <div class="mb-4 ig-form-group">
            <label>Note *</label>
            <div class="ig-rating-input">
              <span *ngFor="let star of [1,2,3,4,5]; let i = index" class="ig-star-input"
                [class.selected]="i < newReview.rating" (click)="setRating(i + 1)"
                [title]="(i + 1) + ' étoile(s)'">★</span>
            </div>
          </div>

          <div class="mb-4 ig-form-group">
            <label for="reviewComment">Commentaire *</label>
            <textarea id="reviewComment" name="comment" [(ngModel)]="newReview.comment" required
              placeholder="Partagez votre expérience..." rows="4"></textarea>
          </div>

          <div class="d-flex flex-column-reverse flex-md-row align-items-end gap-3 mt-5 pt-3 border-top">
            <button type="button" class="ig-btn-secondary" (click)="onBackToReviews()">
              Annuler
            </button>
            <button type="submit" class="ig-btn-primary" [disabled]="!reviewForm.form.valid">
              Publier l'avis
            </button>
          </div>
        </form>
      </div>
      }
    </div>
  </div>
</div>
}