@if (isOpen) {
  <div class="ig-modal-overlay" (click)="onOverlayClick($event)">
    <div class="ig-modal-container" (click)="$event.stopPropagation()" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="d-flex justify-content-between align-items-center p-4 border-bottom ig-modal-header">
            <h3 class="mb-0" id="modal-title">Demande de contrôle terrain</h3>
            <button class="ig-modal-close-btn" (click)="onClose()" aria-label="Fermer la modal" type="button">
                ×
            </button>
        </div>
        
        <div class="p-2">
            <div class="ig-modal-content">
                @if (!isSubmitted) {
                    <div class="ig-study-form">
                        <p class="mb-4">Remplissez ce formulaire pour demander une vérification d'arrêt de travail</p>

                        <form [formGroup]="controlForm" (ngSubmit)="onSubmit()">
                            <!-- Informations du demandeur -->
                            <fieldset class="form-section">
                                <legend>Vos informations</legend>
                                <div class="form-row">
                                    <div class="mb-4 ig-form-group">
                                        <label for="nom">Nom *</label>
                                        <input type="text" id="nom" formControlName="nom" [class.error]="hasFieldError('nom')"
                                            required />
                                        <span *ngIf="hasFieldError('nom')" class="error-message">{{ getFieldError('nom') }}</span>
                                    </div>

                                    <div class="mb-4 ig-form-group">
                                        <label for="prenom">Prénom *</label>
                                        <input type="text" id="prenom" formControlName="prenom"
                                            [class.error]="hasFieldError('prenom')" required />
                                        <span *ngIf="hasFieldError('prenom')" class="error-message">{{ getFieldError('prenom')
                                            }}</span>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="mb-4 ig-form-group">
                                        <label for="telephone">Téléphone *</label>
                                        <input type="tel" id="telephone" formControlName="telephone"
                                            (input)="formatPhoneNumber($event)" [class.error]="hasFieldError('telephone')"
                                            placeholder="01 23 45 67 89" maxlength="14" required />
                                        <span *ngIf="hasFieldError('telephone')" class="error-message">{{ getFieldError('telephone')
                                            }}</span>
                                    </div>

                                    <div class="mb-4 ig-form-group">
                                        <label for="email">Email *</label>
                                        <input type="email" id="email" formControlName="email"
                                            [class.error]="hasFieldError('email')" placeholder="votre@email.com" required />
                                        <span *ngIf="hasFieldError('email')" class="error-message">{{ getFieldError('email')
                                            }}</span>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="mb-4 ig-form-group">
                                        <label for="entreprise">Entreprise *</label>
                                        <input type="text" id="entreprise" formControlName="entreprise"
                                            [class.error]="hasFieldError('entreprise')" placeholder="Nom de votre entreprise"
                                            required />
                                        <span *ngIf="hasFieldError('entreprise')" class="error-message">{{ getFieldError('entreprise') }}</span>
                                    </div>

                                    <div class="mb-4 ig-form-group">
                                        <label for="posteEntreprise">Ville et administration</label>
                                        <input type="text" id="posteEntreprise" formControlName="posteEntreprise" />
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Informations du salarié -->
                            <fieldset class="form-section">
                                <legend>Informations du salarié concerné</legend>
                                <div class="mb-4 ig-form-group">
                                    <label for="posteSalarie">Poste du salarié</label>
                                    <input type="text" id="posteSalarie" formControlName="posteSalarie"
                                        placeholder="Fonction occupée dans l'entreprise" />
                                </div>

                                <div class="form-row">
                                    <div class="mb-4 ig-form-group">
                                        <label for="codePostalSalarie">Code postal *</label>
                                        <input type="text" id="codePostalSalarie" formControlName="codePostalSalarie"
                                            (input)="formatCodePostal($event)" [class.error]="hasFieldError('codePostalSalarie')"
                                            placeholder="75001" maxlength="5" required />
                                        <span *ngIf="hasFieldError('codePostalSalarie')" class="error-message">{{ getFieldError('codePostalSalarie') }}</span>
                                    </div>

                                    <div class="mb-4 ig-form-group">
                                        <label for="villeSalarie">Ville *</label>
                                        <input type="text" id="villeSalarie" formControlName="villeSalarie"
                                            [class.error]="hasFieldError('villeSalarie')" placeholder="Paris" required />
                                        <span *ngIf="hasFieldError('villeSalarie')" class="error-message">{{ getFieldError('villeSalarie') }}</span>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Informations sur l'arrêt -->
                            <fieldset class="form-section">
                                <legend>Informations sur l'arrêt de travail</legend>
                                <div class="form-row">
                                    <div class="mb-4 ig-form-group">
                                        <label for="typeArret">Type d'arrêt</label>
                                        <select id="typeArret" formControlName="typeArret">
                                            <option value="maladie">Maladie</option>
                                            <option value="accident-travail">Accident du travail</option>
                                            <option value="accident-trajet">Accident de trajet</option>
                                            <option value="maladie-professionnelle">Maladie professionnelle</option>
                                            <option value="maternite">Maternité</option>
                                            <option value="paternite">Paternité</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="mb-4 ig-form-group">
                                        <label for="dateDebutArret">Date de début d'arrêt *</label>
                                        <input type="date" id="dateDebutArret" formControlName="dateDebutArret"
                                            [class.error]="hasFieldError('dateDebutArret')" required />
                                        <span *ngIf="hasFieldError('dateDebutArret')" class="error-message">{{ getFieldError('dateDebutArret') }}</span>
                                    </div>

                                    <div class="mb-4 ig-form-group">
                                        <label for="dateFinArret">Date de fin d'arrêt</label>
                                        <input type="date" id="dateFinArret" formControlName="dateFinArret" />
                                    </div>
                                </div>

                                <div class="mb-4 ig-form-group">
                                    <label for="restrictionsSorties">Restrictions de sorties</label>
                                    <select id="restrictionsSorties" formControlName="restrictionsSorties">
                                        <option value="non-precise">Non précisé</option>
                                        <option value="autorisees">Sorties autorisées</option>
                                        <option value="interdites">Sorties interdites</option>
                                        <option value="limitees">Sorties limitées</option>
                                    </select>
                                </div>
                            </fieldset>

                            <!-- Informations complémentaires -->
                            <fieldset class="form-section">
                                <legend>Informations complémentaires</legend>
                                <div class="mb-4 ig-form-group">
                                    <label for="suspicions">Suspicions particulières</label>
                                    <textarea id="suspicions" formControlName="suspicions"
                                        placeholder="Décrivez vos suspicions ou observations particulières..." rows="3"></textarea>
                                </div>

                                <div class="mb-4 ig-form-group">
                                    <label for="message">Message complémentaire</label>
                                    <textarea id="message" formControlName="message" placeholder="Informations complémentaires..."
                                        rows="4"></textarea>
                                </div>
                            </fieldset>

                            <div *ngIf="submitError" class="error-message submit-error">
                                {{ submitError }}
                            </div>

                            <div class="d-flex flex-column-reverse flex-md-row align-items-end gap-3 mt-5 pt-3 border-top">
                                <button type="button" class="ig-btn-secondary" (click)="onClose()" [disabled]="isSubmitting">
                                    Annuler
                                </button>
                                <button type="submit" class="ig-btn-primary" [class.btn-disabled]="!isFormValid"
                                    [disabled]="isSubmitting || !isFormValid">
                                    {{ isSubmitting ? 'Envoi en cours...' : 'Envoyer la demande' }}
                                </button>
                            </div>
                        </form>
                    </div>
                } @else {
                    <div class="success-message">
                        <div class="success-icon">✓</div>
                        <h3>Demande envoyée avec succès !</h3>
                        <p>Votre demande de contrôle terrain a été transmise. Vous recevrez une confirmation par email.</p>
                    </div>
                }
            </div>
        </div>
    </div>
  </div>
}