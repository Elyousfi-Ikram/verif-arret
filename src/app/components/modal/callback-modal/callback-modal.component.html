@if (isOpen) {
  <div class="ig-modal-overlay" (click)="onOverlayClick($event)">
    <div class="ig-modal-container" (click)="$event.stopPropagation()" role="dialog" aria-labelledby="modal-title" aria-modal="true">
      <div class="d-flex justify-content-between align-items-center p-4 border-bottom ig-modal-header">
        <h3 class="mb-0" id="modal-title">Demande de rappel</h3>
        <button class="ig-modal-close-btn" (click)="onClose()" aria-label="Fermer la modal" type="button">
          ×
        </button>
      </div>

      <div class="p-2">
        @if (!isSubmitted) {
          <div class="ig-study-form">
            <p class="mb-4">Remplissez ce formulaire et nous vous rappellerons dans les plus brefs délais</p>

            <form [formGroup]="callbackForm" (ngSubmit)="onSubmit()">
              <div class="form-row">
                <div class="mb-4 ig-form-group">
                  <label for="nom">Nom *</label>
                  <input type="text" id="nom" formControlName="nom"
                      [class.error]="getFieldError('nom')" required>
                  <span *ngIf="getFieldError('nom')" class="error-message">{{ getFieldError('nom') }}</span>
                </div>

                <div class="mb-4 ig-form-group">
                  <label for="prenom">Prénom *</label>
                  <input type="text" id="prenom" formControlName="prenom" [class.error]="getFieldError('prenom')"
                      required>
                  <span *ngIf="getFieldError('prenom')" class="error-message">{{ getFieldError('prenom') }}</span>
                </div>
              </div>

              <div class="form-row">
                <div class="mb-4 ig-form-group">
                  <label for="telephone">Téléphone *</label>
                  <input type="tel" id="telephone" formControlName="telephone" (input)="formatPhoneNumber($event)"
                      [class.error]="getFieldError('telephone')" placeholder="01 23 45 67 89" maxlength="14"
                      required>
                  <span *ngIf="getFieldError('telephone')" class="error-message">{{ getFieldError('telephone') }}</span>
                </div>

                <div class="mb-4 ig-form-group">
                  <label for="email">Email *</label>
                  <input type="email" id="email" formControlName="email" [class.error]="getFieldError('email')"
                      placeholder="votre@email.com" required>
                  <span *ngIf="getFieldError('email')" class="error-message">{{ getFieldError('email') }}</span>
                </div>
              </div>

              <div class="mb-4 ig-form-group">
                <label for="entreprise">Entreprise *</label>
                <input type="text" id="entreprise" formControlName="entreprise"
                    [class.error]="getFieldError('entreprise')" placeholder="Nom de votre entreprise" required>
                <span *ngIf="getFieldError('entreprise')" class="error-message">{{ getFieldError('entreprise') }}</span>
              </div>

              <div class="mb-4 ig-form-group">
                <label for="creneauPrefere">À quelle heure souhaitez-vous être rappelé en toute confidentialité ? *</label>
                <select id="creneauPrefere" formControlName="creneauPrefere" required>
                  <option *ngFor="let option of creneauOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </div>

              <div class="mb-4 ig-form-group">
                <label for="message">Message (optionnel)</label>
                <textarea id="message" formControlName="message" rows="4"
                    placeholder="Décrivez brièvement votre demande..."></textarea>
              </div>

              <div *ngIf="submitError" class="error-message error-message--global">
                {{ submitError }}
              </div>

              <div class="d-flex flex-column-reverse flex-md-row align-items-end gap-3 mt-5 pt-3 border-top">
                <button type="button" class="ig-btn-secondary" (click)="onClose()" [disabled]="isSubmitting">
                  Annuler
                </button>
                <button type="submit" class="ig-btn-primary" [class.btn-disabled]="!isFormValid"
                    [disabled]="isSubmitting || !isFormValid">
                  {{ isSubmitting ? 'Envoi en cours...' : 'Demander un rappel' }}
                </button>
              </div>
            </form>
          </div>
        } @else {
          <div class="success-message">
            <div class="success-icon">✓</div>
            <h3>Demande envoyée !</h3>
            <p>Nous vous rappellerons dans les plus brefs délais.</p>
          </div>
        }
      </div>
    </div>
  </div>
}